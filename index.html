<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SummaryShare - NMU Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <style>
        .hidden { display: none !important; }
        #progressBar { transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .dl-bar { transition: width 0.2s linear; }
        .fav-active { color: #ef4444 !important; }
    </style>
</head>
<body class="min-h-screen bg-slate-100 font-sans text-slate-900">

    <nav class="bg-white shadow-sm border-b sticky top-0 z-40">
        <div class="max-w-5xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 p-1.5 rounded-lg text-white font-bold italic">SS</div>
                <span class="font-bold text-xl text-slate-800">SummaryShare</span>
            </div>
            <div class="flex items-center gap-2">
                <button id="mainUploadBtn" class="bg-indigo-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-indigo-700 shadow-md transition">+ Upload</button>
                <button id="profileBtn" class="hidden w-10 h-10 rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 flex items-center justify-center transition"><i class="fas fa-user"></i></button>
                <button id="logoutBtn" class="hidden text-slate-400 hover:text-red-500 px-2 transition"><i class="fas fa-sign-out-alt text-xl"></i></button>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-4 py-8">
        <div class="space-y-4 mb-8">
            <input type="text" id="searchInput" placeholder="Search title or description..." class="w-full p-4 rounded-2xl border border-slate-200 bg-white outline-none focus:ring-2 focus:ring-indigo-500 shadow-sm">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <select id="filterModule" class="p-3 rounded-xl border bg-white"><option value="">All Modules</option><option value="CVS">CVS</option><option value="BLOOD">BLOOD</option><option value="RESP">RESP</option></select>
                <select id="filterSubject" class="p-3 rounded-xl border bg-white">
                    <option value="">All Subjects</option>
                    <option value="ANATOMY">ANATOMY</option><option value="HISTOLOGY">HISTOLOGY</option><option value="EMBRYOLOGY">EMBRYOLOGY</option>
                    <option value="MICROBIOLOGY">MICROBIOLOGY</option><option value="PATHOLOGY">PATHOLOGY</option><option value="PARASITELOGY">PARASITELOGY</option>
                    <option value="PHARMACOLOGY">PHARMACOLOGY</option><option value="PHYSIOLOGY">PHYSIOLOGY</option><option value="BIOCHEMISTRY">BIOCHEMISTRY</option>
                </select>
                <select id="filterLecture" class="p-3 rounded-xl border bg-white"><option value="">All Lectures</option></select>
            </div>
        </div>
        <div id="feed" class="grid gap-4"></div>
    </main>

    <div id="profileModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] p-8 max-w-2xl w-full shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800" id="userEmailDisplay">Student Profile</h2>
                    <p class="text-slate-500 text-sm">Manage your contributions and saved files</p>
                </div>
                <button id="closeProfile" class="text-slate-400 hover:text-slate-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-slate-50 p-4 rounded-2xl text-center">
                    <span class="block text-2xl font-bold text-indigo-600" id="statUploads">0</span>
                    <span class="text-xs text-slate-500 uppercase font-bold">My Uploads</span>
                </div>
                <div class="bg-slate-50 p-4 rounded-2xl text-center">
                    <span class="block text-2xl font-bold text-indigo-600" id="statFavs">0</span>
                    <span class="text-xs text-slate-500 uppercase font-bold">Saved Items</span>
                </div>
            </div>

            <div class="flex gap-4 border-b mb-4">
                <button id="tabMyUploads" class="pb-2 border-b-2 border-indigo-600 text-indigo-600 font-bold text-sm">My Uploads</button>
                <button id="tabSaved" class="pb-2 border-b-2 border-transparent text-slate-400 font-bold text-sm">Saved</button>
            </div>

            <div id="profileList" class="overflow-y-auto space-y-3 flex-1 pr-2">
                </div>
        </div>
    </div>

    <div id="authModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl max-w-md w-full text-center">
            <h2 class="text-2xl font-bold text-slate-800 mb-2">Student Login</h2>
            <div class="space-y-3">
                <input type="email" id="authEmail" placeholder="name@nmu.edu.eg" class="w-full p-4 rounded-2xl border bg-slate-50 outline-none">
                <input type="password" id="authPass" placeholder="Password (6+ chars)" class="w-full p-4 rounded-2xl border bg-slate-50 outline-none">
                <div class="flex gap-2">
                    <button id="loginBtn" class="flex-1 bg-indigo-600 text-white py-4 rounded-2xl font-bold">Login</button>
                    <button id="signupBtn" class="flex-1 bg-slate-100 text-slate-600 py-4 rounded-2xl font-bold">Sign Up</button>
                </div>
                <button id="closeAuth" class="text-slate-400 text-sm mt-4">Close</button>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="hidden fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] p-8 max-w-lg w-full shadow-2xl overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-bold text-slate-800 mb-4">Post Summary</h2>
            <div class="space-y-4">
                <input type="text" id="docTitle" placeholder="Title" class="w-full p-3.5 rounded-xl border bg-slate-50 outline-none focus:ring-2 focus:ring-indigo-500">
                <textarea id="docDesc" placeholder="Description..." class="w-full p-3.5 rounded-xl border bg-slate-50 outline-none h-24 resize-none"></textarea>
                <div class="grid grid-cols-2 gap-3">
                    <select id="docModule" class="p-3.5 rounded-xl bg-slate-50"><option value="">Module</option><option value="CVS">CVS</option><option value="BLOOD">BLOOD</option><option value="RESP">RESP</option></select>
                    <select id="docSubject" class="p-3.5 rounded-xl bg-slate-50">
                        <option value="">Subject</option>
                        <option value="ANATOMY">ANATOMY</option><option value="HISTOLOGY">HISTOLOGY</option><option value="EMBRYOLOGY">EMBRYOLOGY</option>
                        <option value="MICROBIOLOGY">MICROBIOLOGY</option><option value="PATHOLOGY">PATHOLOGY</option><option value="PARASITELOGY">PARASITELOGY</option>
                        <option value="PHARMACOLOGY">PHARMACOLOGY</option><option value="PHYSIOLOGY">PHYSIOLOGY</option><option value="BIOCHEMISTRY">BIOCHEMISTRY</option>
                    </select>
                </div>
                <select id="docLecture" class="w-full p-3.5 rounded-xl bg-slate-50"><option value="">Select Lecture</option><option value="NOT A LECTURE">NOT A LECTURE</option></select>
                <div class="p-4 border-2 border-dashed rounded-xl bg-slate-50"><input type="file" id="docFile" class="w-full text-sm"></div>
                <div id="progressArea" class="hidden">
                    <div class="w-full bg-slate-100 rounded-full h-2.5 overflow-hidden"><div id="progressBar" class="bg-indigo-600 h-full w-0"></div></div>
                </div>
                <button id="saveBtn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-lg">Post to Feed</button>
                <button id="closeUpload" class="w-full text-slate-400 py-2">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // --- INITIALIZATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBYpA3phiRPlssjDmMp2u9_oqo3YcvQHaU",
            authDomain: "eu-summaryshare.firebaseapp.com",
            projectId: "eu-summaryshare",
            storageBucket: "eu-summaryshare.firebasestorage.app",
            messagingSenderId: "835602685197",
            appId: "1:835602685197:web:ba7219fdeda1c55964e444"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        const auth = firebase.auth();

        let allSummaries = [];
        let userFavs = [];

        // Fill Lectures
        const lecs = document.querySelectorAll('#filterLecture, #docLecture');
        for(let i=1; i<=50; i++) {
            lecs.forEach(s => { const o = document.createElement('option'); o.value = i; o.innerText = `Lecture ${i}`; s.appendChild(o); });
        }

        // --- AUTH & DATA LOAD ---
        auth.onAuthStateChanged(async user => {
            document.getElementById('logoutBtn').classList.toggle('hidden', !user);
            document.getElementById('profileBtn').classList.toggle('hidden', !user);
            if(user) {
                const userDoc = await db.collection("users").doc(user.uid).get();
                userFavs = userDoc.exists ? (userDoc.data().favorites || []) : [];
            } else {
                userFavs = [];
            }
            renderFeed(allSummaries);
        });

        db.collection("summaries").orderBy("timestamp", "desc").onSnapshot(snap => {
            allSummaries = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            applyFilters();
        });

        // --- RENDER FEED ---
        function renderFeed(items) {
            const feed = document.getElementById('feed');
            const user = auth.currentUser;
            feed.innerHTML = items.length ? '' : '<div class="p-12 text-center text-slate-400">No summaries found.</div>';
            
            items.forEach(item => {
                const isFav = userFavs.includes(item.id);
                const isOwner = user && user.uid === item.ownerId;
                const card = document.createElement('div');
                card.className = "bg-white p-6 rounded-2xl shadow-sm border border-slate-50 transition-all hover:shadow-md";
                
                card.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between md:items-center gap-4">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-indigo-50 text-indigo-600 rounded-xl flex items-center justify-center text-xl shrink-0"><i class="fas fa-file-pdf"></i></div>
                            <div>
                                <h3 class="font-bold text-slate-800">${item.title}</h3>
                                <p class="text-xs text-slate-400">By ${item.authorEmail ? item.authorEmail.split('@')[0] : 'Contributor'}</p>
                            </div>
                        </div>
                        <div class="flex gap-2 items-center">
                            <button onclick="toggleFavorite('${item.id}')" class="p-2 text-slate-300 hover:text-red-400 transition ${isFav ? 'fav-active' : ''}">
                                <i class="${isFav ? 'fas' : 'far'} fa-heart text-xl"></i>
                            </button>
                            ${isOwner ? `<button onclick="deleteFile('${item.id}', '${item.fileUrl}')" class="text-red-400 p-2 hover:bg-red-50 rounded-lg"><i class="fas fa-trash-alt"></i></button>` : ''}
                            <a href="https://docs.google.com/viewer?url=${encodeURIComponent(item.fileUrl)}&embedded=true" target="_blank" class="px-4 py-2 bg-slate-100 rounded-xl font-bold text-sm text-slate-600 hover:bg-slate-200">View</a>
                            <button onclick="downloadWithProgress('${item.fileUrl}', '${item.title}.pdf', this)" class="relative overflow-hidden px-4 py-2 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-md min-w-[100px] hover:bg-indigo-700 transition">
                                <span class="btn-text">Download</span>
                                <div class="dl-bar absolute bottom-0 left-0 h-1 bg-indigo-300 w-0"></div>
                            </button>
                        </div>
                    </div>
                `;
                feed.appendChild(card);
            });
        }

        // --- FAVORITE LOGIC ---
        async function toggleFavorite(id) {
            const user = auth.currentUser;
            if(!user || !user.emailVerified) return alert("Please log in and verify email to save summaries.");
            
            const userRef = db.collection("users").doc(user.uid);
            if(userFavs.includes(id)) {
                userFavs = userFavs.filter(f => f !== id);
            } else {
                userFavs.push(id);
            }
            await userRef.set({ favorites: userFavs }, { merge: true });
            renderFeed(allSummaries);
            if(!document.getElementById('profileModal').classList.contains('hidden')) updateProfileUI();
        }

        // --- PROFILE DASHBOARD ---
        document.getElementById('profileBtn').onclick = () => {
            document.getElementById('profileModal').classList.remove('hidden');
            document.getElementById('userEmailDisplay').innerText = auth.currentUser.email.split('@')[0];
            updateProfileUI();
        };

        function updateProfileUI(tab = 'myUploads') {
            const list = document.getElementById('profileList');
            const user = auth.currentUser;
            const myFiles = allSummaries.filter(s => s.ownerId === user.uid);
            const savedFiles = allSummaries.filter(s => userFavs.includes(s.id));
            
            document.getElementById('statUploads').innerText = myFiles.length;
            document.getElementById('statFavs').innerText = savedFiles.length;

            const items = tab === 'myUploads' ? myFiles : savedFiles;
            list.innerHTML = items.length ? '' : '<p class="text-center text-slate-400 py-8 text-sm">Nothing here yet.</p>';

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100";
                div.innerHTML = `
                    <div class="truncate pr-4">
                        <p class="font-bold text-slate-700 text-sm truncate">${item.title}</p>
                        <p class="text-[10px] text-slate-400 uppercase font-bold">${item.module} â€¢ ${item.subject}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="downloadWithProgress('${item.fileUrl}', '${item.title}.pdf', this)" class="text-indigo-600 p-2"><i class="fas fa-download"></i></button>
                        ${tab === 'myUploads' ? `<button onclick="deleteFile('${item.id}', '${item.fileUrl}')" class="text-red-400 p-2"><i class="fas fa-trash-alt"></i></button>` : ''}
                    </div>
                `;
                list.appendChild(div);
            });
        }

        document.getElementById('tabMyUploads').onclick = (e) => {
            document.getElementById('tabSaved').className = "pb-2 border-b-2 border-transparent text-slate-400 font-bold text-sm";
            e.target.className = "pb-2 border-b-2 border-indigo-600 text-indigo-600 font-bold text-sm";
            updateProfileUI('myUploads');
        };
        document.getElementById('tabSaved').onclick = (e) => {
            document.getElementById('tabMyUploads').className = "pb-2 border-b-2 border-transparent text-slate-400 font-bold text-sm";
            e.target.className = "pb-2 border-b-2 border-indigo-600 text-indigo-600 font-bold text-sm";
            updateProfileUI('saved');
        };

        // --- CORE FUNCTIONS (Download/Delete/Auth) ---
        async function downloadWithProgress(url, filename, btn) {
            const textSpan = btn.querySelector('.btn-text') || btn;
            const progressBar = btn.querySelector('.dl-bar');
            try {
                const response = await fetch(url);
                const reader = response.body.getReader();
                const contentLength = +response.headers.get('Content-Length');
                let receivedLength = 0, chunks = []; 
                while(true) {
                    const {done, value} = await reader.read();
                    if (done) break;
                    chunks.push(value);
                    receivedLength += value.length;
                    if (contentLength && progressBar) progressBar.style.width = Math.round((receivedLength/contentLength)*100) + '%';
                }
                const blob = new Blob(chunks);
                const a = document.createElement('a');
                a.href = window.URL.createObjectURL(blob); a.download = filename; a.click();
            } catch (e) { alert("Download failed."); }
        }

        async function deleteFile(id, url) {
            if(!confirm("Delete forever?")) return;
            try {
                await db.collection("summaries").doc(id).delete();
                try { await storage.refFromURL(url).delete(); } catch(e) {}
                if(!document.getElementById('profileModal').classList.contains('hidden')) updateProfileUI();
            } catch(e) { alert("Permission denied."); }
        }

        document.getElementById('signupBtn').onclick = async () => {
            const email = document.getElementById('authEmail').value, pass = document.getElementById('authPass').value;
            if(!email.endsWith('@nmu.edu.eg')) return alert("Use @nmu.edu.eg email!");
            try { 
                const cred = await auth.createUserWithEmailAndPassword(email, pass);
                await cred.user.sendEmailVerification();
                alert("Check your inbox to verify!"); auth.signOut();
                document.getElementById('authModal').classList.add('hidden');
            } catch(e) { alert(e.message); }
        };

        document.getElementById('loginBtn').onclick = async () => {
            try {
                await auth.signInWithEmailAndPassword(document.getElementById('authEmail').value, document.getElementById('authPass').value);
                if (!auth.currentUser.emailVerified) { alert("Please verify your email!"); auth.signOut(); }
                else document.getElementById('authModal').classList.add('hidden');
            } catch(e) { alert("Login failed."); }
        };

        document.getElementById('mainUploadBtn').onclick = () => {
            if(!auth.currentUser) document.getElementById('authModal').classList.remove('hidden');
            else if (!auth.currentUser.emailVerified) alert("Verify your email!");
            else document.getElementById('uploadModal').classList.remove('hidden');
        };

        // --- CLOSING MODALS & FILTERS ---
        document.getElementById('closeProfile').onclick = () => document.getElementById('profileModal').classList.add('hidden');
        document.getElementById('closeAuth').onclick = () => document.getElementById('authModal').classList.add('hidden');
        document.getElementById('closeUpload').onclick = () => document.getElementById('uploadModal').classList.add('hidden');
        document.getElementById('logoutBtn').onclick = () => { auth.signOut(); document.getElementById('profileModal').classList.add('hidden'); };
        
        function applyFilters() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const mod = document.getElementById('filterModule').value;
            const sub = document.getElementById('filterSubject').value;
            renderFeed(allSummaries.filter(i => {
                const text = (i.title + (i.description || "")).toLowerCase().includes(term);
                return text && (!mod || i.module === mod) && (!sub || i.subject === sub);
            }));
        }
        ['searchInput', 'filterModule', 'filterSubject'].forEach(id => document.getElementById(id).addEventListener('input', applyFilters));
        
        document.getElementById('saveBtn').onclick = async () => {
            const file = document.getElementById('docFile').files[0], title = document.getElementById('docTitle').value;
            if (!file || !title) return alert("Required fields missing!");
            document.getElementById('progressArea').classList.remove('hidden');
            const ref = storage.ref(`summaries/${Date.now()}_${file.name}`), task = ref.put(file);
            task.on('state_changed', s => { 
                document.getElementById('progressBar').style.width = (s.bytesTransferred/s.totalBytes)*100 + '%';
            }, null, async () => {
                const url = await task.snapshot.ref.getDownloadURL();
                await db.collection("summaries").add({
                    title, fileUrl: url, description: document.getElementById('docDesc').value,
                    module: document.getElementById('docModule').value, subject: document.getElementById('docSubject').value,
                    lecture: document.getElementById('docLecture').value, ownerId: auth.currentUser.uid,
                    authorEmail: auth.currentUser.email, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('uploadModal').classList.add('hidden');
                document.getElementById('progressArea').classList.add('hidden');
            });
        };
    </script>
</body>
</html>
